---
title: "salience"
author: "Lærke Brædder"
date: "11/2/2021"
output: html_document
---
## Analysis of sub-experiment 1, salience. We want to analyze the time it takes for the image to emerge (rt) as a function of the three compositional dimensions: Blank space (b), noise (n), and complexity (c).

## Loading data and libraries
```{r Loading data and packages}
pacman::p_load(tidyverse,
               lmerTest,
               brms,
               fitdistrplus, # xxx Double check if you actually need these last three. What do they do?
               ggbeeswarm,
               svglite)

# Loading the logfiles and binding them into one big data frame:
filePaths1 <- list.files("data/logfiles-salience-big/", "\\.csv$", full.names = TRUE)
dfs <- do.call(rbind, lapply(filePaths1, read.csv))

# Cleaning the data up a little:
dfs <- dfs %>% rename(RT = Reaction_time) #Renaming the reaction time variable to RT
dfs <- subset(dfs, RT > 0.2) # Removing impossibly fast rt's.
dfs$Correct <- as.factor(dfs$Correctness) #Creating a new column for correctness where it is a factor. The factor column is named 'Correct'
dfs <- subset(dfs,!is.na(Correct)) #Removing incorrect responses from the df. xxx what is actually happening here?
dfs$ID <- as.factor(dfs$ID)
#d <- subset(d,ID!=66) # Excluding participant with all extremely low RTs. Lærke: here they exclude participant 66 due to extremely low rt's, I will have to look through my data to see in this is necessary. I will, however, have to exclude participant 014 and 017 due to them having their boxes completely merged on the screen:
dfs <- subset(dfs, ID != 014)
dfs <- subset(dfs, ID != 017)
# xxx I am not sure is setting these as factors is correct, but I am doint it:
dfs$Complexity <- as.factor(dfs$Complexity)
dfs$Noise <- as.factor(dfs$Noise)
dfs$BlankSpace <- as.factor(dfs$BlankSpace)

# xxx I am not sure what this, from the original script, does:
## d$PeriodL <- d$PeriodL - 2
## dC <- subset(d,Correct==1)
## dC$RT1 <- dC$RT/max(dC$RT)


# xxx Not sure exactly what this does either:
CHAINS = 2
ITER = 8e3
CONTROLS = list(
  max_treedepth = 20,
  adapt_delta=0.999
  )
```


## Exploratory visualization (xxx obs: this is pretty much an exact replica of the 2020 script)
```{r Exploratory Visualization}
# Okay, the reason why I don't need a Type column in because I only have the idealized stim in this dataset. I do not have any trials with original engravings as stim.

# Double-checking the RTs
ggplot(dfs, aes(RT)) + 
  geom_density(aes(fill = Correct, group = Correct, color = Correct), alpha = 0.3) +
  NULL
# original: It looks like a nice gamma, but there is a 0 second mode in correct = 0 (Lærke: I don't think there is in mine, but I will have to check what it looks like in theirs). xxx Lærke: Why is there a correct=0? didn't I remove those?


## By participant
ggplot(dfs, aes(RT)) + 
  geom_density(aes(fill = ID, group = ID, color = ID), alpha = 0.3) +
  guides(fill = FALSE, group = FALSE, color = FALSE) +
  NULL

### Distribution analysis by participant
C1 = subset(dfs, Correctness == 1)
for (i in unique(dfs$ID)){
  x = C1$RT[C1$ID == i]
  fn <- fitdist(x, "norm")
  Normal = summary(fn)$aic
  fln <- fitdist(x, "lnorm")
  LogNormal = summary(fln)$aic
  fg <- fitdist(x, "gamma")
  Gamma=summary(fg)$aic
  x<- data.frame(ID = i, Normal, LogNormal, Gamma)
  if (exists("FitData")){FitData = rbind(FitData, x)}else{FitData=x}
}

C1 <- FitData %>% gather(Distribution, Fit, Normal:Gamma, na.rm = FALSE, convert = FALSE)

ggplot(C1, aes(Distribution, Fit)) +
  geom_violin() +
  geom_beeswarm(aes(color = Distribution))

# Original: Definitely not normal, not super persuasive difference between lognormal and gamma
# Original: Conceptual reflection says gamma
# xxx Lærke: Look at their data to compare

## Let's explore accuracy and rt by the compositional dimensions
# Complexity:
ggplot(dfs, aes(Correct)) +
  geom_bar(stat = "count") + facet_wrap(.~ Complexity)

ggplot(subset(dfs, Correct == 1), aes(Complexity, RT)) +
  geom_violin() +
  geom_beeswarm(aes(color = Complexity))

# Noise:
ggplot(dfs, aes(Correct)) +
  geom_bar(stat="count") + facet_wrap(.~ Noise)

ggplot(subset(dfs,Correct==1),aes(Noise, RT)) +
  geom_violin() +
  geom_beeswarm(aes(color = Noise))

# Blank space:
ggplot(dfs, aes(Correct)) +
  geom_bar(stat="count") + facet_wrap(.~ BlankSpace)

ggplot(subset(dfs,Correct==1),aes(BlankSpace, RT)) +
  geom_violin() +
  geom_beeswarm(aes(color=BlankSpace))

# xxx these are the same whether or not I filter out incorrect answers. But why are we looking at then if I filtered them out? didn't I?

```


## (xxx in the 2020 study they also have this:) "Is accuracy affected by period? Signal Detection Theory model of accuracy" - Accuracy (Correct) as a function of composition. Testing to see how the compositional dimensions affect response accuracy.


### Is RT affected by the compositional dimensions?
models: 
 - "s" stands for salience (in case later on I have both salience, memory, and aesthetics models in my environment)
 - "f" stands for formula
 - "m" stands for model
 - "c" stands for complecity
 - "n" stands for noise
 - "b" stands for blank space
 
 - s_c_f1
 - 

```{r complexity}
# Models conditioning rate only
s_c_f1 <- bf(RT ~ 1 + Complexity + (1 + Complexity | ID) + (1|Stimulus))
s_c_f2 <- bf(RT ~ 1 + Complexity + I(Complexity)^2 + (1 + Complexity  + I(Complexity)^2 |i| ID) + (1|Stimulus))
# xxx: I am not sure if i should include the random effects for Stimulus

# Models conditioning rate and shape. xxx; i don't know what that means. What is shape?
#RT_f1a <- bf(RT ~ 1 + PeriodL + (1 + PeriodL | p | ID) + (1|Drawing),
#             shape ~ 1 + PeriodL + (1 + PeriodL | p | ID))
#RT_f2a <- bf(RT ~ 1 + PeriodL + I(PeriodL)^2 + (1 + PeriodL  + I(PeriodL)^2  | p | ID) + (1|Drawing),
#             shape ~ 1 + PeriodL + I(PeriodL)^2 + (1 + PeriodL + I(PeriodL)^2 | p | ID))


# Get the priors to be set
get_prior(s_c_f2, dfs, family = bernoulli()) # Is the family bernoulli? xxx I don't understand the output. student's t?


s_c_prior <- c(
           prior(normal(0, .3), class = Intercept),
           prior(normal(0, .1), class = b),
           prior(normal(0, .3), class = sd),
           prior(lkj(5),      class=cor))

s_c_m1 <- brm(s_c_f1,
                   family = Gamma(link="log"),
                   data = dfs,
                   prior = s_c_prior,
                   sample_prior = TRUE,
                   chains = CHAINS,cores=CHAINS,
                   iter = ITER,
                   control = CONTROLS)
s_c_m1 <- add_ic(s_c_m1,ic = "loo",cores=CHAINS)

#RT_m1a <- brm(RT_f1a,
#                   family=Gamma(link="log"),
#                   data=subset(dC,Type=="Stimuli"),
#                   prior=RT_prior,
#                   sample_prior=TRUE,
#                   chains=CHAINS,cores=CHAINS,
#                   iter=ITER,
#                   control = CONTROLS)
#RT_m1a <- add_ic(RT_m1a,ic="loo",cores=CHAINS)

s_c_m2 <- brm(s_c_f2,
                   family = Gamma(link="log"),
                   data = dfs,
                   prior = s_c_prior,
                   sample_prior = TRUE,
                   chains = CHAINS,cores=CHAINS,
                   iter = ITER,
                   control = CONTROLS)
s_c_m2 <- add_ic(s_c_m2,ic = "loo",cores=CHAINS)

#RT_m2a <- brm(RT_f2a,
#                   family=Gamma(link="log"),
#                   data=subset(dC,Type=="Stimuli"),
#                   prior=RT_prior,
#                   sample_prior=TRUE,
#                   chains=CHAINS,cores=CHAINS,
#                   iter=ITER, refresh=10,
#                   control = CONTROLS)
#RT_m2a <- add_ic(RT_m2a,ic="loo",cores=CHAINS)


#save(s_c_m1, s_c_m2, file = "Models/Salience_RT_Models_complexity")

# Model comparison
print(compare_ic(s_c_m1, s_c_m2, ic="loo"))
# Summarizing and visualizing results
print(summary(s_c_m1))
print(marginal_effects(s_c_m xxx))
#print(hypothesis(s_c_m xxx, "PeriodL<0")) #Not sure how to handle this
```


```{r noise}
# Models conditioning rate only
s_n_f1 <- bf(RT ~ 1 + Noise + (1 + Noise | ID) + (1|Stimulus))
s_n_f2 <- bf(RT ~ 1 + Noise + I(Noise)^2 + (1 + Noise  + I(Noise)^2 |i| ID) + (1|Stimulus))
# xxx: I am not sure if i should include the random effects for Stimulus

# Models conditioning rate and shape. xxx; i don't know what that means. What is shape?
#RT_f1a <- bf(RT ~ 1 + PeriodL + (1 + PeriodL | p | ID) + (1|Drawing),
#             shape ~ 1 + PeriodL + (1 + PeriodL | p | ID))
#RT_f2a <- bf(RT ~ 1 + PeriodL + I(PeriodL)^2 + (1 + PeriodL  + I(PeriodL)^2  | p | ID) + (1|Drawing),
#             shape ~ 1 + PeriodL + I(PeriodL)^2 + (1 + PeriodL + I(PeriodL)^2 | p | ID))

s_n_prior <- c(
           prior(normal(0, .3), class = Intercept),
           prior(normal(0, .1), class = b),
           prior(normal(0, .3), class = sd),
           prior(lkj(5),      class=cor))

s_n_m1 <- brm(s_n_f1,
                   family = Gamma(link="log"),
                   data = dfs,
                   prior = s_n_prior,
                   sample_prior = TRUE,
                   chains = CHAINS,cores=CHAINS,
                   iter = ITER,
                   control = CONTROLS)
s_n_m1 <- add_ic(s_n_m1,ic = "loo",cores=CHAINS)

#RT_m1a <- brm(RT_f1a,
#                   family=Gamma(link="log"),
#                   data=subset(dC,Type=="Stimuli"),
#                   prior=RT_prior,
#                   sample_prior=TRUE,
#                   chains=CHAINS,cores=CHAINS,
#                   iter=ITER,
#                   control = CONTROLS)
#RT_m1a <- add_ic(RT_m1a,ic="loo",cores=CHAINS)

s_n_m2 <- brm(s_n_f2,
                   family = Gamma(link="log"),
                   data = dfs,
                   prior = s_n_prior,
                   sample_prior = TRUE,
                   chains = CHAINS,cores=CHAINS,
                   iter = ITER,
                   control = CONTROLS)
s_n_m2 <- add_ic(s_n_m2,ic = "loo",cores=CHAINS)

#RT_m2a <- brm(RT_f2a,
#                   family=Gamma(link="log"),
#                   data=subset(dC,Type=="Stimuli"),
#                   prior=RT_prior,
#                   sample_prior=TRUE,
#                   chains=CHAINS,cores=CHAINS,
#                   iter=ITER, refresh=10,
#                   control = CONTROLS)
#RT_m2a <- add_ic(RT_m2a,ic="loo",cores=CHAINS)


#save(s_n_m1, s_n_m2, file = "Models/Salience_RT_Models_noise")

# Model comparison
print(compare_ic(s_n_m1, s_n_m2, ic="loo"))
# Summarizing and visualizing results
print(summary(s_n_m1))
print(marginal_effects(s_n_m xxx))
#print(hypothesis(s_c_m xxx, "PeriodL<0")) #Not sure how to handle this
```


```{r blank space}
# Models conditioning rate only
s_b_f1 <- bf(RT ~ 1 + BlankSpace + (1 + BlankSpace | ID) + (1|Stimulus))
s_b_f2 <- bf(RT ~ 1 + BlankSpace + I(BlankSpace)^2 + (1 + BlankSpace  + I(BlankSpace)^2 |i| ID) + (1|Stimulus))
# xxx: I am not sure if i should include the random effects for Stimulus

# Models conditioning rate and shape. xxx; i don't know what that means. What is shape?
#RT_f1a <- bf(RT ~ 1 + PeriodL + (1 + PeriodL | p | ID) + (1|Drawing),
#             shape ~ 1 + PeriodL + (1 + PeriodL | p | ID))
#RT_f2a <- bf(RT ~ 1 + PeriodL + I(PeriodL)^2 + (1 + PeriodL  + I(PeriodL)^2  | p | ID) + (1|Drawing),
#             shape ~ 1 + PeriodL + I(PeriodL)^2 + (1 + PeriodL + I(PeriodL)^2 | p | ID))

s_b_prior <- c(
           prior(normal(0, .3), class = Intercept),
           prior(normal(0, .1), class = b),
           prior(normal(0, .3), class = sd),
           prior(lkj(5),      class=cor))

s_b_m1 <- brm(s_b_f1,
                   family = Gamma(link="log"),
                   data = dfs,
                   prior = s_b_prior,
                   sample_prior = TRUE,
                   chains = CHAINS,cores=CHAINS,
                   iter = ITER,
                   control = CONTROLS)
s_b_m1 <- add_ic(s_b_m1,ic = "loo",cores=CHAINS)

#RT_m1a <- brm(RT_f1a,
#                   family=Gamma(link="log"),
#                   data=subset(dC,Type=="Stimuli"),
#                   prior=RT_prior,
#                   sample_prior=TRUE,
#                   chains=CHAINS,cores=CHAINS,
#                   iter=ITER,
#                   control = CONTROLS)
#RT_m1a <- add_ic(RT_m1a,ic="loo",cores=CHAINS)

s_b_m2 <- brm(s_b_f2,
                   family = Gamma(link="log"),
                   data = dfs,
                   prior = s_b_prior,
                   sample_prior = TRUE,
                   chains = CHAINS,cores=CHAINS,
                   iter = ITER,
                   control = CONTROLS)
s_b_m2 <- add_ic(s_b_m2,ic = "loo",cores=CHAINS)

#RT_m2a <- brm(RT_f2a,
#                   family=Gamma(link="log"),
#                   data=subset(dC,Type=="Stimuli"),
#                   prior=RT_prior,
#                   sample_prior=TRUE,
#                   chains=CHAINS,cores=CHAINS,
#                   iter=ITER, refresh=10,
#                   control = CONTROLS)
#RT_m2a <- add_ic(RT_m2a,ic="loo",cores=CHAINS)


#save(s_b_m1, s_b_m2, file = "Models/Salience_RT_Models_blankspace")

# Model comparison
print(compare_ic(s_b_m1, s_b_m2, ic="loo"))
# Summarizing and visualizing results
print(summary(s_b_m1))
print(marginal_effects(s_b_m xxx))
#print(hypothesis(s_c_m xxx, "PeriodL<0")) #Not sure how to handle this
```



### Plots of the RT findings

```{r}
## Plot for the main manuscript - Figure N
dfs_agg <- dfs %>% group_by(ID, Complexity, Noise, BlankSpace) %>% dplyr::summarize(
  mRT = mean(RT, na.rm=T),
  sdRT = sd(RT, na.rm=T),
  mRT_log = mean(log(RT), na.rm=T),
  sdRT_log = sd(log(RT), na.rm=T))

dfs_agg$Complexity <- as.numeric(dfs_agg$Complexity)
dfs_agg$Noise <- as.numeric(dfs_agg$Noise)
dfs_agg$BlankSpace <- as.numeric(dfs_agg$BlankSpace)

# Complexity plot:
s_CPlot <- ggplot(subset(dfs_agg, mRT_log > 0), aes(Complexity, mRT)) + 
  geom_line(aes(group=ID,color=ID),alpha=0.3) +
  geom_point(aes(group=ID,color=ID),alpha=0.3)+
  geom_smooth(method=lm) +
  theme_classic() +
  ylab("Time to emerge (seconds)") +
  xlab("Complexity") +
  scale_color_discrete(guide=FALSE) +
  scale_x_continuous(breaks = c(1,2,3),labels=c("Low", "Medium", "High")) +
  NULL

# Noise plot:
s_NPlot <- ggplot(subset(dfs_agg, mRT_log > 0), aes(Noise, mRT)) + 
  geom_line(aes(group=ID,color=ID),alpha=0.3) +
  geom_point(aes(group=ID,color=ID),alpha=0.3)+
  geom_smooth(method=lm) +
  theme_classic() +
  ylab("Time to emerge (seconds)") +
  xlab("Noise") +
  scale_color_discrete(guide=FALSE) +
  scale_x_continuous(breaks = c(1,2,3),labels=c("Low", "Medium", "High")) +
  NULL

# Blank space plot:
s_BPlot <- ggplot(subset(dfs_agg, mRT_log > 0), aes(BlankSpace, mRT)) + 
  geom_line(aes(group=ID,color=ID),alpha=0.3) +
  geom_point(aes(group=ID,color=ID),alpha=0.3)+
  geom_smooth(method=lm) +
  theme_classic() +
  ylab("Time to emerge (seconds)") +
  xlab("Blank Space") +
  scale_color_discrete(guide=FALSE) +
  scale_x_continuous(breaks = c(1,2,3),labels=c("Low", "Medium", "High")) +
  NULL

s_CPlot
s_NPlot
s_BPlot

#ggsave("Plots/s_CPlot.svg", plot = s_CPlot)


```

